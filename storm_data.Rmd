---
output:
  html_document:
    keep_md: yes
---
# NOAA Storm Data
## JHU-DS Reproducible Research Peer Assesment 2  
This is the second peer assessment required for the JHU Reproducible Research course through Coursera. The project examines data from the National Oceanic and Atmospheric Administrations' severe weather database in order to answer basic questions about storm events. This project uses R throughout.

##Data Processing
###Dataset
The data come from the NOAA National Climatic Data Center Storm Events database, and cover years 1950 to 2011.  
###Prep the workspace
Load required libraries:
```{r loadLibs}
library(data.table)
library(R.utils)
library(ggplot2)
library(dplyr)
```

###Download the data
Then dowload the data, and load the data into memory:
```{r loadData, cache=TRUE}
url <- "https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2"
fn <- "stormdata.csv"
if(!file.exists(fn)) download.file(url, fn, mode="wb")
if(!file.exists(fn)) bunzip2("stormdata.bz2", fn, remove=FALSE)
storm <- read.csv(fn)
dt <- data.table(storm)
rm(storm)
```

###Data Munging

Convert the date to a date-class variable and save as a new var in the data.table. Convert the various time values into something more uniform.

```{r toDTG, cache=TRUE}
# unifTime converts all the weird time entries into a uniform time format
unifTime <- function(char.time){
    if(nchar(char.time) > 4){
        t <- substr(char.time, 0, 5)
    } else if(nchar(char.time) <= 4){
        y <- sprintf("%04s", char.time)
        t <- paste(substr(y, 0, 2), substr(y, 3, 4), sep=":")
    } else {
        break()
    }
    return(t)
}

```

```{r munging, results='hide', warning=FALSE}
setnames(dt1, tolower(names(dt1)))
to.keep <- c("state", "evtype", "bgn_date", "bgn_time", "mag", "fatalities", "injuries", "propdmg", "propdmgexp", "cropdmg", "cropdmgexp")
dt1 <- dt[, to.keep, with=FALSE] #new table with only selected columns

dt1[, bgn_date:=as.character(bgn_date)]
dt1[, bgn_time:=as.character(bgn_time)]
dt1[, date:=as.Date(bgn_date, format="%m/%d/%Y")]
dt1[, time:=unifTime(bgn_time), by=1:nrow(dt1)]
```

##Data Analysis
Determine fatalities and injuries by event type and by year.
```{r healthImpact, results='hide'}
fatal <- dt1[, sum(fatalities), by=list(evtype, year(date))]
f1 <- fatal[, sum(V1), by=evtype] #summed by event type over all years
f1.max <- f1[which.max(f1$V1)] # which is most fatal?
f2 <- fatal[, .SD[which.max(V1)], by=year] 
f2.max <- count(f2, evtype) # which is most fatal by year?
f2.an <- f2[which.max(V1)] # which year was most fatal?

injured <- dt1[, sum(injuries), by=list(evtype, year(date))]
i1 <- injured[, sum(V1), by=evtype] #summed by event type over all years
i1.max <- i1[which.max(f1$V1)]
i2 <- injured[, .SD[which.max(V1)], by=year]
i2.max <- count(i2, evtype)

```
```{r econImpact, results='hide'}
# convert propdmexp and cropdmgexp into multiplicative factors
# adjust propdmg and cropdmg to actual values
# overall
# by year
# worst year

```
##Results
Across the US, which types of events are the most harmful to population health?
###Population Health Impact
####Total over all years
Tornadoes are the deadliest and most injurious adverse weather events, as measured by the total number of people killed and injured. In total, `r f1.max$V1` people were killed by tornadoes between 1950 and 2011. `r i1.max$V1` people were injured by tornadoes during the same time period.
####Annually
Tornadoes were the most deadly weather most, but not all years. For 45 out of the 61 years in the dataset, tornadoes were the deadliest adverse weather condion tracked. Excessive heat was the deadliest weather condition for 8 out fo the 61 years (with just plain 'heat' addiding an additional year), and flash floods were the deadliest for 4 of the years in the dataset.  
The dealiest year in the dataset was `r f2.an$year`, when `r f2.an$V1` people died from `r tolower(f2.an$evtype)`.
###Economic Impact
###Recommendations